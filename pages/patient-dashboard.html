<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard - LifeLine QR</title>

    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages.css">

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="../index.html" class="navbar-brand">
                <span class="medical-icon">+</span>
                LifeLine QR
            </a>
            <ul class="navbar-menu">
                <li><a href="./patient-dashboard.html">Dashboard</a></li>
                <li><a href="./merchandise.html">Order QR Card</a></li>
                <li><button class="btn btn-sm btn-danger" onclick="handleLogout()">Logout</button></li>
            </ul>
        </div>
    </nav>

    <section class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <div>
                    <h1 id="userGreeting">Patient Dashboard</h1>
                    <p class="text-muted">Manage your medical information</p>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Profile Information -->
                <div class="dashboard-section">
                    <h3>Profile Information</h3>
                    <div id="profileInfo"></div>
                    <button class="btn btn-primary mt-3" onclick="showEditProfile()">Edit Profile</button>
                </div>

                <!-- QR Code -->
                <div class="dashboard-section">
                    <h3>Your QR Code</h3>
                    <div class="qr-container">
                        <div id="qrcode" class="qr-code"></div>
                        <p class="mt-2"><strong>QR Code ID:</strong> <span id="qrCodeId"></span></p>
                        <button class="btn btn-primary mt-2" onclick="downloadQRCode()">Download QR Code</button>
                        <a href="./merchandise.html" class="btn btn-success mt-2">Order Physical QR Card</a>
                    </div>
                </div>

                <!-- Medical Documents -->
                <div class="dashboard-section" style="grid-column: 1 / -1;">
                    <h3>Medical Documents</h3>
                    <div class="form-group">
                        <label class="form-label">Upload Medical Document</label>
                        <input type="file" id="fileInput" class="form-input" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Document Description</label>
                        <input type="text" id="fileDescription" class="form-input"
                            placeholder="e.g., Blood Test Report, X-Ray">
                    </div>
                    <button class="btn btn-primary" onclick="uploadDocument()">Upload Document</button>

                    <div class="mt-4">
                        <h4>Uploaded Documents</h4>
                        <ul id="documentList" class="document-list"></ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="form-group">
                        <label class="form-label">Allergies</label>
                        <textarea id="editAllergies" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Medical Conditions</label>
                        <textarea id="editConditions" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Regular Medications</label>
                        <textarea id="editMedications" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="editAddress" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Emergency Contact</label>
                        <input type="tel" id="editEmergency" class="form-input">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/validation.js"></script>
    <script src="../js/qr-handler.js"></script>
    <script src="../js/router.js"></script>
    <script src="../js/main.js"></script>

    <script>
        // Require authentication
        if (!Auth.requireAuth() || !Auth.isRole(CONFIG.ROLES.PATIENT)) {
            window.location.href = './login.html';
        }

        const currentUser = Auth.getCurrentUser();
        let qrCodeData = '';

        // Load patient data
        function loadPatientData() {
            const fullUser = UserStorage.getUserById(currentUser.id);

            // Display profile info
            const profileDiv = document.getElementById('profileInfo');
            profileDiv.innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Name:</div>
                        <div class="info-value">${fullUser.name}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Age:</div>
                        <div class="info-value">${fullUser.age} years</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Blood Group:</div>
                        <div class="info-value"><span class="badge badge-danger">${fullUser.bloodGroup}</span></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Email:</div>
                        <div class="info-value">${fullUser.email}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Allergies:</div>
                        <div class="info-value">${fullUser.allergies || 'None'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Medical Conditions:</div>
                        <div class="info-value">${fullUser.medicalConditions || 'None'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Regular Medications:</div>
                        <div class="info-value">${fullUser.regularMedications || 'None'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Emergency Contact:</div>
                        <div class="info-value">${fullUser.emergencyContacts || 'Not provided'}</div>
                    </div>
                </div>
            `;

            // Generate and display QR code
            const qrMapping = QRStorage.getQRByPatient(currentUser.id);
            if (qrMapping) {
                qrCodeData = qrMapping.qrCode;
                document.getElementById('qrCodeId').textContent = qrCodeData;
                QRHandler.generateQR('qrcode', qrCodeData);
            }

            // Load documents
            loadDocuments();
        }

        // Load documents
        function loadDocuments() {
            const records = MedicalRecordStorage.getPatientRecords(currentUser.id);
            const docList = document.getElementById('documentList');

            if (records.length === 0) {
                docList.innerHTML = '<li class="empty-state"><p>No documents uploaded yet</p></li>';
                return;
            }

            docList.innerHTML = records.map(record => `
                <li class="document-item">
                    <div class="document-info">
                        <div class="document-name">${record.filename}</div>
                        <div class="document-desc">${record.description || 'No description'}</div>
                        <small class="text-muted">Uploaded: ${Utils.formatDate(record.createdAt)}</small>
                    </div>
                    <div class="document-actions">
                        <button class="btn btn-sm btn-primary" onclick="viewDocument('${record.id}')">View</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDocument('${record.id}')">Delete</button>
                    </div>
                </li>
            `).join('');
        }

        // Upload document
        async function uploadDocument() {
            const fileInput = document.getElementById('fileInput');
            const description = document.getElementById('fileDescription').value.trim();

            if (!fileInput.files.length) {
                Utils.showAlert('Please select a file', 'error');
                return;
            }

            const file = fileInput.files[0];
            const validation = Utils.validateFile(file);

            if (!validation.valid) {
                Utils.showAlert(validation.errors.join(', '), 'error');
                return;
            }

            try {
                const base64 = await Utils.fileToBase64(file);

                const record = {
                    filename: file.name,
                    fileType: file.type,
                    fileData: base64,
                    description: description || 'Medical Document',
                    uploadedAt: new Date().toISOString()
                };

                MedicalRecordStorage.addRecord(currentUser.id, record);

                Utils.showAlert('Document uploaded successfully', 'success');
                fileInput.value = '';
                document.getElementById('fileDescription').value = '';
                loadDocuments();
            } catch (error) {
                Utils.showAlert('Failed to upload document', 'error');
            }
        }

        // View document
        function viewDocument(recordId) {
            const record = Storage.getById(CONFIG.STORAGE_KEYS.MEDICAL_RECORDS, recordId);
            if (!record) return;

            const link = document.createElement('a');
            link.href = record.fileData;
            link.download = record.filename;
            link.target = '_blank';
            link.click();
        }

        // Delete document
        function deleteDocument(recordId) {
            if (confirm('Are you sure you want to delete this document?')) {
                MedicalRecordStorage.deleteRecord(recordId);
                Utils.showAlert('Document deleted', 'success');
                loadDocuments();
            }
        }

        // Show edit profile modal
        function showEditProfile() {
            const user = UserStorage.getUserById(currentUser.id);
            document.getElementById('editAllergies').value = user.allergies || '';
            document.getElementById('editConditions').value = user.medicalConditions || '';
            document.getElementById('editMedications').value = user.regularMedications || '';
            document.getElementById('editAddress').value = user.address || '';
            document.getElementById('editEmergency').value = user.emergencyContacts || '';

            document.getElementById('editModal').classList.add('active');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Handle edit form
        document.getElementById('editForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const updates = {
                allergies: document.getElementById('editAllergies').value.trim(),
                medicalConditions: document.getElementById('editConditions').value.trim(),
                regularMedications: document.getElementById('editMedications').value.trim(),
                address: document.getElementById('editAddress').value.trim(),
                emergencyContacts: document.getElementById('editEmergency').value.trim()
            };

            UserStorage.updateUser(currentUser.id, updates);
            Auth.createSession({ ...currentUser, ...updates });

            Utils.showAlert('Profile updated successfully', 'success');
            closeEditModal();
            loadPatientData();
        });

        // Download QR code
        function downloadQRCode() {
            QRHandler.downloadQR('qrcode', `lifeline-qr-${currentUser.name.replace(/\s+/g, '-')}.png`);
        }

        // Initialize
        loadPatientData();
    </script>
</body>

</html>