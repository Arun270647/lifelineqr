<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard - LifeLine QR</title>

    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages.css">

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="../index.html" class="navbar-brand">
                <span class="medical-icon">+</span>
                LifeLine QR
            </a>
            <ul class="navbar-menu">
                <li><a href="./patient-dashboard.html">Dashboard</a></li>
                <li><a href="./merchandise.html">Order QR Card</a></li>
                <li><button class="btn btn-sm btn-danger" onclick="handleLogout()">Logout</button></li>
            </ul>
        </div>
    </nav>

    <section class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <div>
                    <h1 id="userGreeting">Patient Dashboard</h1>
                    <p class="text-muted">Manage your medical information</p>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Profile Information -->
                <div class="dashboard-section">
                    <h3>Profile Information</h3>
                    <div id="profileInfo"></div>
                    <button class="btn btn-primary mt-3" onclick="showEditProfile()">Edit Profile</button>
                </div>

                <!-- QR Code -->
                <div class="dashboard-section">
                    <h3>Your QR Code</h3>
                    <div class="qr-container">
                        <div id="qrcode" class="qr-code"></div>
                        <p class="mt-2"><strong>QR Code ID:</strong> <span id="qrCodeId"></span></p>
                        <button class="btn btn-primary mt-2" onclick="downloadQRCode()">Download QR Code</button>
                        <a href="./merchandise.html" class="btn btn-success mt-2">Order Physical QR Card</a>
                    </div>
                </div>

                <!-- Medical Documents -->
                <div class="dashboard-section" style="grid-column: 1 / -1;">
                    <h3>Medical Documents</h3>
                    <div class="mt-4">
                        <ul id="documentList" class="document-list"></ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="form-group">
                        <label class="form-label">Allergies</label>
                        <textarea id="editAllergies" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Medical Conditions</label>
                        <textarea id="editConditions" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Regular Medications</label>
                        <textarea id="editMedications" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="editAddress" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Emergency Contact</label>
                        <input type="tel" id="editEmergency" class="form-input">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/validation.js"></script>
    <script src="../js/qr-handler.js"></script>
    <script src="../js/router.js"></script>
    <script src="../js/main.js"></script>

    <script>
        // Get current user from session (set during login)
        const currentUser = JSON.parse(sessionStorage.getItem(CONFIG.STORAGE_KEYS.CURRENT_USER));

        if (!currentUser || currentUser.role !== 'patient') {
            window.location.href = '/pages/login.html';
        }

        // Set greeting
        document.getElementById('userGreeting').textContent = `Welcome, ${currentUser.name}`;

        let qrCodeData = '';

        // Load patient data from API
        async function loadPatientData() {
            try {
                const res = await fetch(`http://localhost:5000/api/patient/${currentUser.id}`);
                const data = await res.json();

                if (!data.success) {
                    Utils.showAlert('Failed to load profile', 'error');
                    return;
                }

                const p = data.patient;

                // Display profile info
                const profileDiv = document.getElementById('profileInfo');
                profileDiv.innerHTML = `
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Name:</div>
                            <div class="info-value">${p.name}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Age:</div>
                            <div class="info-value">${p.age} years</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Blood Group:</div>
                            <div class="info-value"><span class="badge badge-danger">${p.blood_group || 'N/A'}</span></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Email:</div>
                            <div class="info-value">${p.email}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Allergies:</div>
                            <div class="info-value">${p.allergies || 'None'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Medical Conditions:</div>
                            <div class="info-value">${p.medical_conditions || 'None'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Regular Medications:</div>
                            <div class="info-value">${p.regular_medications || 'None'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Emergency Contact:</div>
                            <div class="info-value">${p.emergency_contacts || 'Not provided'}</div>
                        </div>
                    </div>
                `;

                // Generate QR code from patient ID
                qrCodeData = `LIFELINE-QR-${p.id}`;
                document.getElementById('qrCodeId').textContent = qrCodeData;
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById('qrcode'), {
                    text: qrCodeData,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H   // High error correction — more scannable
                });

                // Load documents
                loadDocuments();

            } catch (err) {
                console.error(err);
                Utils.showAlert('Server error loading profile', 'error');
            }
        }

        // Load documents from API
        async function loadDocuments() {
            try {
                const res = await fetch(`http://localhost:5000/api/patient/${currentUser.id}/documents`);
                const data = await res.json();
                const docList = document.getElementById('documentList');

                if (!data.success || data.documents.length === 0) {
                    docList.innerHTML = '<li class="empty-state"><p>No documents uploaded yet</p></li>';
                    return;
                }

                docList.innerHTML = data.documents.map(record => `
                    <li class="document-item">
                        <div class="document-info">
                            <div class="document-name">${record.filename}</div>
                            <div class="document-desc">${record.description || 'No description'}</div>
                            <small class="text-muted">Uploaded: ${Utils.formatDate(record.uploaded_at)}</small>
                        </div>
                        <div class="document-actions">
                            <button class="btn btn-sm btn-primary" onclick="viewDocument('${record.id}')">View</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDocument('${record.id}')">Delete</button>
                        </div>
                    </li>
                `).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('documentList').innerHTML = '<li class="text-danger">Failed to load documents</li>';
            }
        }

        // View document - fetch full content only when requested
        async function viewDocument(docId) {
            try {
                const res = await fetch(`http://localhost:5000/api/document/${docId}`);
                const data = await res.json();

                if (data.success) {
                    const record = data.document;
                    const link = document.createElement('a');
                    link.href = record.file_data; // This is the base64 string
                    link.download = record.filename;
                    link.target = '_blank';
                    link.click();
                } else {
                    Utils.showAlert('Failed to load document', 'error');
                }
            } catch (err) {
                console.error(err);
                Utils.showAlert('Server error', 'error');
            }
        }

        // Delete document via API
        async function deleteDocument(docId) {
            if (confirm('Are you sure you want to delete this document?')) {
                try {
                    const res = await fetch(`http://localhost:5000/api/document/${docId}`, {
                        method: 'DELETE'
                    });
                    const data = await res.json();

                    if (data.success) {
                        Utils.showAlert('Document deleted', 'success');
                        loadDocuments();
                    } else {
                        Utils.showAlert('Failed to delete document', 'error');
                    }
                } catch (err) {
                    console.error(err);
                    Utils.showAlert('Server error', 'error');
                }
            }
        }

        // Show edit profile modal
        async function showEditProfile() {
            try {
                const res = await fetch(`http://localhost:5000/api/patient/${currentUser.id}`);
                const data = await res.json();
                if (data.success) {
                    const p = data.patient;
                    document.getElementById('editAllergies').value = p.allergies || '';
                    document.getElementById('editConditions').value = p.medical_conditions || '';
                    document.getElementById('editMedications').value = p.regular_medications || '';
                    document.getElementById('editAddress').value = p.address || '';
                    document.getElementById('editEmergency').value = p.emergency_contacts || '';
                }
            } catch (err) {
                console.error(err);
            }
            document.getElementById('editModal').classList.add('active');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Handle edit form — save to API
        document.getElementById('editForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const updates = {
                allergies: document.getElementById('editAllergies').value.trim(),
                medical_conditions: document.getElementById('editConditions').value.trim(),
                regular_medications: document.getElementById('editMedications').value.trim(),
                address: document.getElementById('editAddress').value.trim(),
                emergency_contacts: document.getElementById('editEmergency').value.trim()
            };

            try {
                const res = await fetch(`http://localhost:5000/api/patient/${currentUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                const data = await res.json();

                if (data.success) {
                    Utils.showAlert('Profile updated successfully', 'success');
                    closeEditModal();
                    loadPatientData();
                } else {
                    Utils.showAlert(data.error || 'Update failed', 'error');
                }
            } catch (err) {
                Utils.showAlert('Server error', 'error');
                console.error(err);
            }
        });

        // Download QR code
        function downloadQRCode() {
            QRHandler.downloadQR('qrcode', `lifeline-qr-${currentUser.name.replace(/\s+/g, '-')}.png`);
        }

        // Logout
        function handleLogout() {
            sessionStorage.removeItem(CONFIG.STORAGE_KEYS.CURRENT_USER);
            window.location.href = '/pages/login.html';
        }

        // Initialize
        loadPatientData();
    </script>
</body>

</html>