<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - LifeLine QR</title>

    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages.css">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="../index.html" class="navbar-brand">
                <span class="medical-icon">+</span>
                LifeLine QR
            </a>
            <ul class="navbar-menu">
                <li><a href="./doctor-dashboard.html">Dashboard</a></li>
                <li><a href="./doctors-list.html">Doctors List</a></li>
                <li><button class="btn btn-sm btn-danger" onclick="handleLogout()">Logout</button></li>
            </ul>
        </div>
    </nav>

    <section class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <div>
                    <h1 id="userGreeting">Doctor Dashboard</h1>
                    <p class="text-muted">Access patient medical information</p>
                </div>
            </div>

            <!-- QR Lookup -->
            <div class="card">
                <h3>Patient Lookup</h3>
                <p>Enter the patient's QR code ID to view their medical information</p>
                <div class="form-group">
                    <label class="form-label">QR Code ID</label>
                    <input type="text" id="qrInput" class="form-input" placeholder="Enter or paste QR code ID">
                </div>
                <button class="btn btn-primary" onclick="lookupPatient()">Search Patient</button>
            </div>

            <!-- Patient Info Display -->
            <div id="patientInfoCard" class="card hidden">
                <div class="card-header">
                    <h3>Patient Information</h3>
                    <button class="btn btn-sm btn-secondary" onclick="clearPatientInfo()">Clear</button>
                </div>
                <div id="patientInfo"></div>

                <!-- Medical Records -->
                <div id="medicalRecordsSection" class="mt-4 hidden">
                    <h4 class="mb-3">Medical Documents</h4>
                    <ul id="medicalRecordsList" class="document-list"></ul>
                </div>
            </div>
        </div>
    </section>

    <script src="../js/config.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/qr-handler.js"></script>
    <script src="../js/router.js"></script>
    <script src="../js/main.js"></script>

    <script>
        // Get current user from session
        const currentUser = JSON.parse(sessionStorage.getItem(CONFIG.STORAGE_KEYS.CURRENT_USER));

        if (!currentUser || currentUser.role !== 'doctor') {
            window.location.href = '/pages/login.html';
        }

        // Set greeting
        document.getElementById('userGreeting').textContent = `Welcome back, ${currentUser.name}!`;

        // Lookup patient by QR code via API
        async function lookupPatient() {
            const qrCode = document.getElementById('qrInput').value.trim();

            if (!qrCode) {
                Utils.showAlert('Please enter a QR code ID', 'error');
                return;
            }

            // Extract patient ID from QR code format: LIFELINE-QR-{id}
            const match = qrCode.match(/^LIFELINE-QR-(\d+)$/i);
            if (!match) {
                Utils.showAlert('Invalid QR code format. Expected: LIFELINE-QR-{id}', 'error');
                clearPatientInfo();
                return;
            }

            const patientId = match[1];

            try {
                const res = await fetch(`http://localhost:5000/api/patient/${patientId}`);
                const data = await res.json();

                if (!data.success) {
                    Utils.showAlert('Patient not found', 'error');
                    clearPatientInfo();
                    return;
                }

                displayPatientInfo(data.patient);
            } catch (err) {
                Utils.showAlert('Server error. Make sure the backend is running.', 'error');
                console.error(err);
            }
        }

        // Display patient information
        function displayPatientInfo(p) {
            const infoCard = document.getElementById('patientInfoCard');
            const infoDiv = document.getElementById('patientInfo');

            infoDiv.innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Name:</div>
                        <div class="info-value">${p.name}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Age:</div>
                        <div class="info-value">${p.age} years</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Blood Group:</div>
                        <div class="info-value"><span class="badge badge-danger">${p.blood_group || 'N/A'}</span></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Allergies:</div>
                        <div class="info-value">${p.allergies || 'None'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Medical Conditions:</div>
                        <div class="info-value">${p.medical_conditions || 'None'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Regular Medications:</div>
                        <div class="info-value">${p.regular_medications || 'None'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Emergency Contacts:</div>
                        <div class="info-value">${p.emergency_contacts || 'Not provided'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Address:</div>
                        <div class="info-value">${p.address || 'Not provided'}</div>
                    </div>
                </div>
            `;

            infoCard.classList.remove('hidden');

            // Hide medical records section (not implemented via API yet)
            const recordsSection = document.getElementById('medicalRecordsSection');
            recordsSection.innerHTML = '<p class="text-muted">No medical documents uploaded</p>';
            recordsSection.classList.remove('hidden');
        }

        // Clear patient info
        function clearPatientInfo() {
            document.getElementById('qrInput').value = '';
            document.getElementById('patientInfoCard').classList.add('hidden');
            document.getElementById('patientInfo').innerHTML = '';
            document.getElementById('medicalRecordsSection').classList.add('hidden');
        }

        // Logout
        function handleLogout() {
            sessionStorage.removeItem(CONFIG.STORAGE_KEYS.CURRENT_USER);
            window.location.href = '/pages/login.html';
        }

        // Allow Enter key to search
        document.getElementById('qrInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                lookupPatient();
            }
        });
    </script>
</body>

</html>