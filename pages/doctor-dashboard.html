<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - LifeLine QR</title>

    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="../index.html" class="navbar-brand">
                <span class="medical-icon">+</span>
                LifeLine QR
            </a>
            <ul class="navbar-menu">
                <li><a href="./doctor-dashboard.html">Dashboard</a></li>
                <li><a href="./doctors-list.html">Doctors List</a></li>
                <li><button class="btn btn-sm btn-danger" onclick="handleLogout()">Logout</button></li>
            </ul>
        </div>
    </nav>

    <section class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <div>
                    <h1 id="userGreeting">Doctor Dashboard</h1>
                    <p class="text-muted">Access student medical information</p>
                </div>
            </div>

            <!-- QR Lookup -->
            <div class="card">
                <h3>Student Lookup</h3>
                <p>Enter the student's QR code ID to view their medical information</p>
                <div class="form-group">
                    <label class="form-label">QR Code ID</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="qrInput" class="form-input" placeholder="Enter or paste QR code ID">
                        <button class="btn btn-secondary" onclick="startQRScanner()" style="white-space: nowrap;">
                            üì∑ Scan QR
                        </button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="lookupStudent()">Search Student</button>
            </div>

            <!-- Student Info Display -->
            <div id="studentInfoCard" class="card hidden">
                <div class="card-header">
                    <h3>Student Information</h3>
                    <button class="btn btn-sm btn-secondary" onclick="clearStudentInfo()">Clear</button>
                </div>
                <div id="studentInfo"></div>

                <!-- Medical Records -->
                <div id="medicalRecordsSection" class="mt-4 hidden">
                    <h4 class="mb-3">Medical Documents</h4>
                    <ul id="medicalRecordsList" class="document-list"></ul>
                </div>

                <!-- Upload Document for Student -->
                <div id="uploadSection" class="mt-4 hidden">
                    <h4 class="mb-3">Upload Document for Student</h4>
                    <div class="form-group">
                        <label class="form-label">Select Document</label>
                        <input type="file" id="docFileInput" class="form-input" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" id="docDescription" class="form-input"
                            placeholder="e.g., Health Checkup Report, Vaccination Record">
                    </div>
                    <button class="btn btn-success" onclick="uploadDocForStudent()">üìÑ Upload Document</button>
                </div>
            </div>
        </div>
    </section>

    <!-- GPay-style QR Scanner Modal -->
    <div id="scannerModal" class="modal">
        <div class="modal-content"
            style="max-width: 480px; background: #000; border-radius: 16px; overflow: hidden; padding: 0;">

            <!-- Header -->
            <div style="display:flex; align-items:center; justify-content:space-between;
                        padding: 14px 18px; background:#111;">
                <h3 style="margin:0; color:#fff; font-size:17px; font-weight:600;">üì∑ Scan Student QR</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button id="torchBtn" onclick="toggleTorch()" title="Toggle flashlight" style="background:rgba(255,255,255,0.12); border:none; border-radius:50%;
                               width:36px; height:36px; font-size:18px; cursor:pointer;
                               display:flex; align-items:center; justify-content:center;">üî¶</button>
                    <button onclick="stopQRScanner()"
                        style="background:rgba(255,255,255,0.12); border:none; border-radius:50%;
                               width:36px; height:36px; font-size:20px; color:#fff; cursor:pointer;
                               display:flex; align-items:center; justify-content:center; line-height:1;">&times;</button>
                </div>
            </div>

            <!-- Camera view -->
            <div style="position:relative; background:#000;">
                <!-- html5-qrcode renders into #reader -->
                <div id="reader" style="width:100%;"></div>

                <!-- Corner bracket overlay -->
                <div id="scanOverlay" style="position:absolute; inset:0; pointer-events:none;">

                    <!-- Dark vignette outside the scan zone -->
                    <div id="vignetteTop"
                        style="position:absolute; left:0; right:0; top:0; background:rgba(0,0,0,0.5);"></div>
                    <div id="vignetteBottom"
                        style="position:absolute; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5);"></div>
                    <div id="vignetteLeft"
                        style="position:absolute; top:0; bottom:0; left:0; background:rgba(0,0,0,0.5);"></div>
                    <div id="vignetteRight"
                        style="position:absolute; top:0; bottom:0; right:0; background:rgba(0,0,0,0.5);"></div>

                    <!-- Corner brackets (green, GPay-style) -->
                    <div id="bracketBox" style="position:absolute; box-sizing:border-box;">
                        <!-- TL -->
                        <div
                            style="position:absolute; top:-2px; left:-2px; width:28px; height:28px;
                                    border-top:4px solid #00e676; border-left:4px solid #00e676; border-radius:4px 0 0 0;">
                        </div>
                        <!-- TR -->
                        <div
                            style="position:absolute; top:-2px; right:-2px; width:28px; height:28px;
                                    border-top:4px solid #00e676; border-right:4px solid #00e676; border-radius:0 4px 0 0;">
                        </div>
                        <!-- BL -->
                        <div
                            style="position:absolute; bottom:-2px; left:-2px; width:28px; height:28px;
                                    border-bottom:4px solid #00e676; border-left:4px solid #00e676; border-radius:0 0 0 4px;">
                        </div>
                        <!-- BR -->
                        <div
                            style="position:absolute; bottom:-2px; right:-2px; width:28px; height:28px;
                                    border-bottom:4px solid #00e676; border-right:4px solid #00e676; border-radius:0 0 4px 0;">
                        </div>

                        <!-- Animated laser line -->
                        <div id="laserLine" style="
                            position:absolute; left:4px; right:4px; height:2px;
                            background: linear-gradient(90deg, transparent, #00e676, #69ff47, #00e676, transparent);
                            box-shadow: 0 0 8px #00e676, 0 0 18px #00e676;
                            animation: laserSweep 1.8s ease-in-out infinite;
                        "></div>
                    </div>
                </div>
            </div>

            <!-- Hint text -->
            <p style="margin:0; padding:14px 0 18px; text-align:center;
                       color:rgba(255,255,255,0.7); font-size:13px; background:#111;">
                Hold the QR code <strong style="color:#fff;">anywhere in view</strong> ‚Äî it will scan automatically
            </p>
        </div>
    </div>

    <style>
        @keyframes laserSweep {
            0% {
                top: 4px;
                opacity: 1;
            }

            50% {
                top: calc(100% - 6px);
                opacity: 1;
            }

            100% {
                top: 4px;
                opacity: 1;
            }
        }
    </style>

    <script src="../js/config.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/qr-handler.js"></script>
    <script src="../js/router.js"></script>
    <script src="../js/main.js"></script>

    <script>
        let html5QrCode;
        let torchOn = false;
        let currentStudentId = null; // Track the currently viewed student

        function startQRScanner() {
            document.getElementById('scannerModal').classList.add('active');
            torchOn = false;

            // Destroy any stale instance
            if (html5QrCode) {
                try { html5QrCode.stop().catch(() => { }); } catch (e) { }
                html5QrCode = null;
            }
            html5QrCode = new Html5Qrcode('reader');

            const qrboxFn = (w, h) => {
                const side = Math.floor(Math.min(w, h) * 0.85);
                return { width: side, height: side };
            };

            const config = {
                fps: 30,
                qrbox: qrboxFn
            };

            html5QrCode
                .start({ facingMode: 'environment' }, config, onScanSuccess)
                .then(() => {
                    positionOverlay();
                })
                .catch(err => {
                    console.error('Scanner start error', err);
                    Utils.showAlert('Could not start camera. Please check permissions.', 'error');
                    document.getElementById('scannerModal').classList.remove('active');
                });
        }

        // Align the decorative bracket box over the real scan region
        function positionOverlay() {
            setTimeout(() => {
                const readerEl = document.getElementById('reader');
                const video = readerEl.querySelector('video');
                if (!video) return;

                const rw = readerEl.offsetWidth;
                const rh = video.offsetHeight || readerEl.offsetHeight;
                const side = Math.floor(Math.min(rw, rh) * 0.85);
                const left = Math.floor((rw - side) / 2);
                const top = Math.floor((rh - side) / 2);

                // Vignette panels
                const vT = document.getElementById('vignetteTop');
                const vB = document.getElementById('vignetteBottom');
                const vL = document.getElementById('vignetteLeft');
                const vR = document.getElementById('vignetteRight');
                if (vT) { vT.style.height = top + 'px'; }
                if (vB) { vB.style.height = (rh - top - side) + 'px'; }
                if (vL) { vL.style.top = top + 'px'; vL.style.bottom = (rh - top - side) + 'px'; vL.style.width = left + 'px'; }
                if (vR) { vR.style.top = top + 'px'; vR.style.bottom = (rh - top - side) + 'px'; vR.style.width = (rw - left - side) + 'px'; }

                // Bracket box
                const bb = document.getElementById('bracketBox');
                if (bb) {
                    bb.style.left = left + 'px';
                    bb.style.top = top + 'px';
                    bb.style.width = side + 'px';
                    bb.style.height = side + 'px';
                }

                // Overlay container matches video height
                const overlay = document.getElementById('scanOverlay');
                if (overlay) overlay.style.height = rh + 'px';
            }, 600);
        }

        function onScanSuccess(decodedText) {
            // Flash green to confirm scan
            const bb = document.getElementById('bracketBox');
            if (bb) {
                bb.querySelectorAll('div').forEach(d => d.style.borderColor = '#ffffff');
                setTimeout(() => {
                    bb.querySelectorAll('div').forEach(d => d.style.borderColor = '#00e676');
                }, 200);
            }
            document.getElementById('qrInput').value = decodedText;
            stopQRScanner();
            setTimeout(() => lookupStudent(), 300);
        }

        // Torch / flashlight toggle
        async function toggleTorch() {
            if (!html5QrCode) return;
            try {
                torchOn = !torchOn;
                await html5QrCode.applyVideoConstraints({
                    advanced: [{ torch: torchOn }]
                });
                document.getElementById('torchBtn').style.background =
                    torchOn ? 'rgba(255,230,0,0.3)' : 'rgba(255,255,255,0.12)';
            } catch (e) {
                console.warn('Torch not supported on this device', e);
            }
        }

        function stopQRScanner() {
            if (html5QrCode) {
                html5QrCode.stop()
                    .then(() => { html5QrCode.clear(); html5QrCode = null; })
                    .catch(() => { html5QrCode = null; });
            }
            document.getElementById('scannerModal').classList.remove('active');
        }

        // Get current user from session
        const currentUser = JSON.parse(sessionStorage.getItem(CONFIG.STORAGE_KEYS.CURRENT_USER));

        if (!currentUser || currentUser.role !== 'doctor') {
            window.location.href = './login.html';
        }

        if (!currentUser.is_verified) {
            document.querySelector('.dashboard .container').innerHTML = `
                <div class="dashboard-header">
                    <div>
                        <h1 id="userGreeting">Welcome back, ${currentUser.name}!</h1>
                        <p class="text-muted">Account Verification Pending</p>
                    </div>
                </div>
                <div class="card" style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                    <h3>Verification Pending</h3>
                    <p style="color: var(--text-secondary); margin-top: 10px;">Your account is currently under review by the administrator. Once verified, you will be able to scan QR codes and access student medical records.</p>
                </div>
            `;
        } else {
            // Set greeting for verified users
            document.getElementById('userGreeting').textContent = `Welcome back, ${currentUser.name}!`;
        }

        // Lookup student by QR code ‚Äî handles all QR formats
        async function lookupStudent() {
            const qrCode = document.getElementById('qrInput').value.trim();

            if (!qrCode) {
                Utils.showAlert('Please enter a QR code ID', 'error');
                return;
            }

            let studentId = null;

            // Format 1: LIFELINE-QR-{id}  (standard format)
            const stdMatch = qrCode.match(/LIFELINE-QR-(\d+)/i);
            if (stdMatch) studentId = stdMatch[1];

            // Format 2: URL containing ?id={id} or &id={id}
            if (!studentId) {
                const urlMatch = qrCode.match(/[?&]id=(\d+)/i);
                if (urlMatch) studentId = urlMatch[1];
            }

            // Format 3: bare numeric ID typed manually (e.g. "4")
            if (!studentId && /^\d+$/.test(qrCode)) {
                studentId = qrCode;
            }

            // Format 4: old embedded plain-text QR (EMERGENCY MEDICAL INFO block)
            if (!studentId && (qrCode.includes('EMERGENCY MEDICAL INFO') || qrCode.includes('Name:'))) {
                const extract = (label) => {
                    const re = new RegExp(label + ':\\s*(.+)', 'i');
                    const m = qrCode.match(re);
                    return m ? m[1].trim() : 'N/A';
                };
                displayStudentInfo({
                    name: extract('Name'),
                    age: extract('Age'),
                    blood_group: extract('Blood Group'),
                    allergies: extract('Allergies'),
                    medical_conditions: extract('Medical Conditions'),
                    regular_medications: extract('Medications'),
                    emergency_contacts: extract('Emergency Contact'),
                    address: extract('Address')
                });
                displayMedicalRecords([]);
                Utils.showAlert('Student info loaded from QR text (documents not available for this format).', 'info');
                return;
            }

            if (!studentId) {
                Utils.showAlert('Unrecognized QR code format. Please scan a valid LifeLine QR code.', 'error');
                clearStudentInfo();
                return;
            }

            try {
                const [studentRes, docsRes] = await Promise.all([
                    fetch(`http://localhost:5000/api/student/${studentId}`),
                    fetch(`http://localhost:5000/api/student/${studentId}/documents`)
                ]);

                const studentData = await studentRes.json();
                const docsData = await docsRes.json();

                if (!studentData.success) {
                    Utils.showAlert('Student not found. Check the QR code and try again.', 'error');
                    clearStudentInfo();
                    return;
                }

                currentStudentId = studentId; // Save for document upload
                displayStudentInfo(studentData.student);
                displayMedicalRecords(docsData.documents || []);

            } catch (err) {
                Utils.showAlert('Server error. Make sure the backend is running.', 'error');
                console.error(err);
            }
        }

        // Display student information
        function displayStudentInfo(p) {
            const infoCard = document.getElementById('studentInfoCard');
            const infoDiv = document.getElementById('studentInfo');

            infoDiv.innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Name:</div>
                        <div class="info-value">${p.name}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Age:</div>
                        <div class="info-value">${p.age} years</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Class:</div>
                        <div class="info-value">${p.student_class || 'N/A'}${p.section ? ' - ' + p.section : ''}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Roll No:</div>
                        <div class="info-value">${p.roll_number || 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Blood Group:</div>
                        <div class="info-value"><span class="badge badge-danger">${p.blood_group || 'N/A'}</span></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Allergies:</div>
                        <div class="info-value">${p.allergies || 'None'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Medical Conditions:</div>
                        <div class="info-value">${p.medical_conditions || 'None'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Regular Medications:</div>
                        <div class="info-value">${p.regular_medications || 'None'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Parent / Guardian:</div>
                        <div class="info-value">${p.parent_name || 'Not provided'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Parent Contact:</div>
                        <div class="info-value">${p.emergency_contacts || 'Not provided'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Address:</div>
                        <div class="info-value">${p.address || 'Not provided'}</div>
                    </div>
                </div>
            `;

            infoCard.classList.remove('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
        }

        // Display medical records
        function displayMedicalRecords(records) {
            const recordsSection = document.getElementById('medicalRecordsSection');

            if (!records || records.length === 0) {
                recordsSection.innerHTML = '<p class="text-muted">No medical documents uploaded</p>';
            } else {
                recordsSection.innerHTML = '<h4 class="mb-3">Medical Documents</h4><ul id="medicalRecordsList" class="document-list"></ul>';
                const list = document.getElementById('medicalRecordsList');

                list.innerHTML = records.map(record => `
                    <li class="document-item">
                        <div class="document-info">
                            <div class="document-name">${record.filename}</div>
                            <div class="document-desc">${record.description || 'No description'}</div>
                            <small class="text-muted">Uploaded: ${Utils.formatDate(record.uploaded_at)}</small>
                        </div>
                        <div class="document-actions">
                            <button class="btn btn-sm btn-primary" onclick="viewDocument('${record.id}')">View/Download</button>
                        </div>
                    </li>
                `).join('');
            }
            recordsSection.classList.remove('hidden');
        }

        // View document - fetch full content only when requested
        async function viewDocument(docId) {
            try {
                const res = await fetch(`http://localhost:5000/api/document/${docId}`);
                const data = await res.json();

                if (data.success) {
                    const record = data.document;
                    const link = document.createElement('a');
                    link.href = record.file_data;
                    link.download = record.filename;
                    link.target = '_blank';
                    link.click();
                } else {
                    Utils.showAlert('Failed to load document', 'error');
                }
            } catch (err) {
                console.error(err);
                Utils.showAlert('Server error', 'error');
            }
        }

        // Upload document for currently viewed student
        async function uploadDocForStudent() {
            if (!currentStudentId) {
                Utils.showAlert('No student selected. Please search for a student first.', 'error');
                return;
            }

            const fileInput = document.getElementById('docFileInput');
            const description = document.getElementById('docDescription').value.trim();

            if (!fileInput.files.length) {
                Utils.showAlert('Please select a file to upload.', 'error');
                return;
            }

            const file = fileInput.files[0];

            // Validate file
            const validation = Utils.validateFile(file);
            if (!validation.valid) {
                Utils.showAlert(validation.errors.join(', '), 'error');
                return;
            }

            try {
                const base64 = await Utils.fileToBase64(file);

                const res = await fetch(`http://localhost:5000/api/student/${currentStudentId}/documents`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: file.name,
                        fileData: base64,
                        description: description || 'Medical Document'
                    })
                });

                const data = await res.json();

                if (data.success) {
                    Utils.showAlert('Document uploaded successfully!', 'success');
                    // Clear the form
                    fileInput.value = '';
                    document.getElementById('docDescription').value = '';
                    // Reload documents list
                    const docsRes = await fetch(`http://localhost:5000/api/student/${currentStudentId}/documents`);
                    const docsData = await docsRes.json();
                    displayMedicalRecords(docsData.documents || []);
                } else {
                    Utils.showAlert(data.error || 'Upload failed', 'error');
                }
            } catch (err) {
                console.error(err);
                Utils.showAlert('Server error while uploading document.', 'error');
            }
        }

        // Clear student info
        function clearStudentInfo() {
            currentStudentId = null;
            document.getElementById('qrInput').value = '';
            document.getElementById('studentInfoCard').classList.add('hidden');
            document.getElementById('studentInfo').innerHTML = '';
            document.getElementById('medicalRecordsSection').classList.add('hidden');
            document.getElementById('uploadSection').classList.add('hidden');
        }

        // Logout
        function handleLogout() {
            sessionStorage.removeItem(CONFIG.STORAGE_KEYS.CURRENT_USER);
            window.location.href = './login.html';
        }

        // Allow Enter key to search
        document.getElementById('qrInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                lookupStudent();
            }
        });
    </script>
</body>

</html>